<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Painel LATAM Compacto</title>
<style>
  body {
    margin: 0;
    padding: 10px;
    font-family: Arial, sans-serif;
    background: #111;
    color: #eee;
    overflow: hidden; /* Sem scroll geral */
    display: flex;
    height: 100vh;
  }
  .container {
    display: flex;
    gap: 10px;
    width: 100%;
    height: 100%;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.8rem;
    background: #222;
    color: #eee;
  }
  th, td {
    border: 1px solid #444;
    padding: 4px 6px;
    text-align: center;
    white-space: nowrap;
  }
  th {
    background: #333;
    font-weight: bold;
    position: sticky;
    top: 0;
    z-index: 2;
  }

  /* Tabela MALHA ocupa 40% largura, não tem scroll */
  #malha {
    flex: 0 0 40%;
    overflow: hidden;
  }

  /* Tabela PAINEL ocupa 60% largura, scroll vertical */
  #painel {
    flex: 0 0 60%;
    overflow-y: auto;
    max-height: 100%;
    position: relative;
  }

  /* Linhas novas MALHA (vermelho) */
  tr.nova {
    animation: piscarVermelho 2s ease-in-out 3;
  }
  @keyframes piscarVermelho {
    0%, 100% { background-color: transparent; }
    50% { background-color: #a00; }
  }

  /* Linha amarelo check-in */
  tr.checkin-atual {
    background-color: #f4d35e !important;
    transition: background-color 1s ease;
  }

  /* Linha amarelo ETD */
  tr.etd-atual {
    background-color: #ffb703 !important;
    transition: background-color 1s ease;
  }

  /* Pequeno som e avisos */
  #status {
    position: fixed;
    bottom: 10px;
    left: 10px;
    font-size: 0.75rem;
    color: #ccc;
  }
</style>
</head>
<body>
  <div class="container">
    <div id="malha">
      <h3>MALHA (últimos cortes)</h3>
      <table id="tabela-malha">
        <thead>
          <tr>
            <th>Voo</th><th>Tipo</th><th>Avião</th><th>Rota</th><th>Peso Corte</th><th>Motivo</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="painel">
      <h3>PAINEL (check-in e ETD)</h3>
      <table id="tabela-painel">
        <thead>
          <tr>
            <th>Data</th><th>Voo</th><th>Origem</th><th>Destino</th><th>Acft</th><th>Check-in</th><th>ETD</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div id="status">Atualizando...</div>

<script>
const urlAPI = 'https://script.google.com/macros/s/AKfycbybJfXvelOC_cLcKqMo134lrCg3UjGUBQmqdruKSxWAo6Pg_7MnHZqUeroELaHA_QM/exec';

const malhaTbody = document.querySelector('#tabela-malha tbody');
const painelTbody = document.querySelector('#tabela-painel tbody');
const statusDiv = document.getElementById('status');

let ultimosPesos = [];
let checkinTimeouts = new Map();
let etdTimeouts = new Map();

async function buscarDados() {
  statusDiv.textContent = 'Buscando dados...';
  try {
    const res = await fetch(urlAPI);
    const dados = await res.json();

    atualizarMalha(dados.filter(d => d.origem === 'MALHA'));
    atualizarPainel(dados.filter(d => d.origem === 'PLANEJAMENTO'));

    statusDiv.textContent = `Última atualização: ${new Date().toLocaleTimeString()}`;
  } catch (e) {
    statusDiv.textContent = 'Erro ao buscar dados.';
    console.error(e);
  }
}

function atualizarMalha(dadosMalha) {
  // Verifica novas linhas (pesos que ainda não estavam)
  let novos = [];
  dadosMalha.forEach(item => {
    if (!ultimosPesos.includes(item.pesodecorte)) {
      novos.push(item);
    }
  });
  ultimosPesos = dadosMalha.map(i => i.pesodecorte);

  malhaTbody.innerHTML = '';
  dadosMalha.forEach(item => {
    const tr = document.createElement('tr');
    if (novos.find(n => n.pesodecorte === item.pesodecorte)) {
      tr.classList.add('nova');
    }
    tr.innerHTML = `
      <td>${item.voo}</td>
      <td>${item.tipo}</td>
      <td>${item.aviao}</td>
      <td>${item.rota}</td>
      <td>${item.pesodecorte}</td>
      <td>${item.motivo}</td>
    `;
    malhaTbody.appendChild(tr);
  });
}

function tocarSom(url) {
  const audio = new Audio(url);
  audio.play().catch(() => {});
}

// Limpa efeito amarelo após 1 minuto
function limparAmarelo(tr, classe) {
  if (classe === 'checkin-atual') {
    clearTimeout(checkinTimeouts.get(tr));
    checkinTimeouts.delete(tr);
  } else if (classe === 'etd-atual') {
    clearTimeout(etdTimeouts.get(tr));
    etdTimeouts.delete(tr);
  }
  tr.classList.remove(classe);
}

// Atualiza Painel e controla sons e destaques
function atualizarPainel(dadosPainel) {
  painelTbody.innerHTML = '';

  const agora = new Date();

  dadosPainel.forEach(item => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.data}</td>
      <td>${item.voo}</td>
      <td>${item.origemRota}</td>
      <td>${item.destino}</td>
      <td>${item.acft}</td>
      <td>${item.checkin}</td>
      <td>${item.etd}</td>
    `;

    painelTbody.appendChild(tr);

    // Comparar horários atuais com check-in e ETD
    if (item.checkin) {
      const checkinDate = parseHoraData(item.data, item.checkin);
      if (checarHorarioAgora(checkinDate, agora)) {
        tr.classList.add('checkin-atual');
        tocarSom('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
        // Remove destaque após 1 min
        const timeoutId = setTimeout(() => limparAmarelo(tr, 'checkin-atual'), 60000);
        checkinTimeouts.set(tr, timeoutId);
      }
    }

    if (item.etd) {
      const etdDate = parseHoraData(item.data, item.etd);
      if (checarHorarioAgora(etdDate, agora)) {
        tr.classList.add('etd-atual');
        tocarSom('https://actions.google.com/sounds/v1/transportation/airplane_takeoff.ogg');
        // Remove destaque após 1 min
        const timeoutId = setTimeout(() => limparAmarelo(tr, 'etd-atual'), 60000);
        etdTimeouts.set(tr, timeoutId);
      }
    }
  });

  // Scroll PAINEL para cima (mais recentes no topo)
  painelTbody.parentElement.scrollTop = 0;
}

// Função para montar um Date a partir de data string (formato dd/mm ou yyyy-mm-dd) + hora hh:mm
function parseHoraData(dataStr, horaStr) {
  try {
    let hoje = new Date();
    let dia, mes, ano;
    if (dataStr.includes('/')) {
      // formato dd/mm ou dd/mm/yyyy
      let partes = dataStr.split('/');
      dia = parseInt(partes[0]);
      mes = parseInt(partes[1]) - 1;
      ano = partes.length === 3 ? parseInt(partes[2]) : hoje.getFullYear();
    } else if (dataStr.includes('-')) {
      // formato yyyy-mm-dd
      let partes = dataStr.split('-');
      ano = parseInt(partes[0]);
      mes = parseInt(partes[1]) - 1;
      dia = parseInt(partes[2]);
    } else {
      dia = hoje.getDate();
      mes = hoje.getMonth();
      ano = hoje.getFullYear();
    }
    let partesHora = horaStr.split(':');
    let hora = parseInt(partesHora[0]);
    let min = parseInt(partesHora[1]);
    return new Date(ano, mes, dia, hora, min, 0, 0);
  } catch {
    return null;
  }
}

// Checa se horário está entre agora e 59 segundos depois (pra avisar 1 vez)
function checarHorarioAgora(data, agora) {
  if (!data) return false;
  const diff = data.getTime() - agora.getTime();
  return diff >= 0 && diff < 60000; // dentro de 1 minuto
}

// Atualiza a cada 10s (pode ajustar)
setInterval(buscarDados, 10000);
buscarDados();
</script>
</body>
</html>
