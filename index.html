<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel LATAM</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      gap: 20px;
      padding: 20px;
      background: #121212;
      color: #eee;
    }
    table {
      border-collapse: collapse;
      width: 48%;
      background: #222;
      border-radius: 6px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #555;
      padding: 8px 12px;
      text-align: center;
    }
    th {
      background: #333;
      font-weight: bold;
    }
    .new-row {
      background-color: #b33030 !important;
      color: white;
      transition: background-color 1s ease;
    }
    .checkin-alert {
      background-color: #d6b345 !important;
      color: black;
      transition: background-color 1s ease;
    }
    .etd-alert {
      background-color: #4a90e2 !important;
      color: white;
      transition: background-color 1s ease;
    }
  </style>
</head>
<body>

  <table id="malhaTable">
    <thead>
      <tr>
        <th colspan="6">MALHA</th>
      </tr>
      <tr>
        <th>Voo</th>
        <th>Tipo</th>
        <th>Avião</th>
        <th>Rota</th>
        <th>Peso Corte</th>
        <th>Motivo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <table id="painelTable">
    <thead>
      <tr>
        <th colspan="8">PAINEL</th>
      </tr>
      <tr>
        <th>Data</th>
        <th>Voo</th>
        <th>Origem</th>
        <th>Destino</th>
        <th>Avião</th>
        <th>Check-in</th>
        <th>ETD</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  const urlAPI = 'https://script.google.com/macros/s/AKfycbwvEhPp4VBNjlOuL2Y0eqRc1EHREbv6vuucxgGPhzvWe26tX2sp6p6H6Jhb9S3-7b9H/exec'; // <--- coloque a URL do seu webapp aqui

  // Estado pra detectar linhas novas MALHA e tempo de destaque
  const malhaIds = new Set();

  // Estado pra controlar alertas de checkin e ETD (pra não disparar som várias vezes)
  const checkinAlertaAtivos = new Set();
  const etdAlertaAtivos = new Set();

  function tocaSom(freq, duration=500) {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
    oscillator.connect(audioCtx.destination);
    oscillator.start();
    setTimeout(() => {
      oscillator.stop();
      audioCtx.close();
    }, duration);
  }

  function formataHora(texto) {
    // formato esperado "HH:mm"
    if (!texto) return null;
    const parts = texto.split(':');
    if(parts.length !== 2) return null;
    const d = new Date();
    d.setHours(parseInt(parts[0],10));
    d.setMinutes(parseInt(parts[1],10));
    d.setSeconds(0);
    d.setMilliseconds(0);
    return d;
  }

  function atualiza() {
    fetch(urlAPI)
      .then(r => r.json())
      .then(dados => {
        // Separar MALHA e PAINEL
        const malha = dados.filter(item => item.origem === 'MALHA');
        const painel = dados.filter(item => item.origem === 'PLANEJAMENTO');

        atualizaMalha(malha);
        atualizaPainel(painel);
      })
      .catch(err => console.error('Erro fetch API:', err));
  }

  function atualizaMalha(dados) {
    const tbody = document.querySelector('#malhaTable tbody');
    tbody.innerHTML = '';

    dados.forEach(item => {
      const row = document.createElement('tr');

      // Identificador único simples (voo + peso + motivo)
      const id = item.voo + '|' + item.pesodecorte + '|' + item.motivo;

      if (!malhaIds.has(id)) {
        // Nova linha detectada
        malhaIds.add(id);
        row.classList.add('new-row');
        // Remover destaque vermelho após 10s
        setTimeout(() => {
          row.classList.remove('new-row');
        }, 10000);
      }

      row.innerHTML = `
        <td>${item.voo}</td>
        <td>${item.tipo || ''}</td>
        <td>${item.aviao || ''}</td>
        <td>${item.rota || ''}</td>
        <td>${item.pesodecorte}</td>
        <td>${item.motivo || ''}</td>
      `;
      tbody.appendChild(row);
    });
  }

  function atualizaPainel(dados) {
    const tbody = document.querySelector('#painelTable tbody');
    tbody.innerHTML = '';

    const agora = new Date();

    dados.forEach(item => {
      const row = document.createElement('tr');

      // Formatando checkin e ETD para Date
      const checkinDate = formataHora(item.checkin);
      const etdDate = formataHora(item.etd);

      // Comparar horário atual com checkin para alertar
      if (checkinDate && Math.abs(agora - checkinDate) < 60000) { // menos de 1min de diferença
        if (!checkinAlertaAtivos.has(item.voo)) {
          checkinAlertaAtivos.add(item.voo);
          row.classList.add('checkin-alert');
          tocaSom(440, 1500); // som 440Hz por 1,5s
          setTimeout(() => {
            row.classList.remove('checkin-alert');
            checkinAlertaAtivos.delete(item.voo);
          }, 60000);
        } else {
          row.classList.add('checkin-alert');
        }
      }

      // Comparar horário atual com ETD para alertar avião partindo
      if (etdDate && Math.abs(agora - etdDate) < 60000) { // menos de 1min
        if (!etdAlertaAtivos.has(item.voo)) {
          etdAlertaAtivos.add(item.voo);
          row.classList.add('etd-alert');
          tocaSom(880, 2000); // som 880Hz por 2s
          setTimeout(() => {
            row.classList.remove('etd-alert');
            etdAlertaAtivos.delete(item.voo);
          }, 60000);
        } else {
          row.classList.add('etd-alert');
        }
      }

      row.innerHTML = `
        <td>${item.data || ''}</td>
        <td>${item.voo || ''}</td>
        <td>${item.origemRota || ''}</td>
        <td>${item.destino || ''}</td>
        <td>${item.acft || ''}</td>
        <td>${item.checkin || ''}</td>
        <td>${item.etd || ''}</td>
      `;
      tbody.appendChild(row);
    });
  }

  // Atualiza a cada 30 segundos
  atualiza();
  setInterval(atualiza, 30000);
</script>

</body>
</html>
